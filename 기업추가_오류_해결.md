# 🔧 기업 추가 오류 해결 완료

## 📋 문제 요약

### 🚨 발생한 오류

```
오류: HTTP 400:
/api/companies:1  Failed to load resource: the server responded with a status of 400 ()
app.js:33 API 호출 오류: Error: HTTP 400
```

### ⚠️ 원인

**입력 검증 미들웨어의 잘못된 설정**

보안 개선 작업 시 추가한 `validateCompany` 미들웨어에서:
- `optional({ nullable: true })` 옵션 사용
- 이 옵션은 `null` 또는 `undefined`만 허용
- **빈 문자열(`""`)**은 검증 대상으로 간주 → 검증 실패 → 400 에러

```javascript
// ❌ 문제가 있던 코드
body('businessNumber')
    .optional({ nullable: true })  // 빈 문자열("") 처리 안 됨!
    .trim()
    .matches(/^\d{3}-\d{2}-\d{5}$/)
```

**실제 상황**:
- 사용자가 사업자번호 미입력 → 프론트엔드에서 `""` (빈 문자열) 전송
- 서버는 빈 문자열을 검증 → 형식 오류 → 400 에러 반환

---

## ✅ 해결 방법

### 수정된 코드

```javascript
// ✅ 수정된 코드
const validateCompany = [
    body('name')
        .trim()
        .notEmpty().withMessage('기업명은 필수입니다')
        .isLength({ min: 1, max: 100 }).withMessage('기업명은 1-100자여야 합니다')
        .matches(/^[a-zA-Z0-9가-힣\s\-_()&.]+$/).withMessage('기업명에 허용되지 않은 문자가 포함되어 있습니다'),
    
    body('businessNumber')
        .optional({ checkFalsy: true })  // ✅ 빈 문자열도 허용
        .trim()
        .custom((value) => {
            // 값이 있을 때만 형식 검증
            if (value && !/^\d{3}-\d{2}-\d{5}$/.test(value)) {
                throw new Error('사업자번호 형식이 올바르지 않습니다 (예: 123-45-67890)');
            }
            return true;
        }),
    
    body('email')
        .optional({ checkFalsy: true })  // ✅ 빈 문자열도 허용
        .trim()
        .custom((value) => {
            // 값이 있을 때만 이메일 검증
            if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                throw new Error('올바른 이메일 형식이 아닙니다');
            }
            return true;
        }),
    
    body('commission')
        .optional({ checkFalsy: true })  // ✅ 빈 문자열도 허용
        .custom((value) => {
            // 값이 있을 때만 숫자 검증
            if (value !== '' && value !== null && value !== undefined) {
                const num = parseFloat(value);
                if (isNaN(num) || num < 0 || num > 100) {
                    throw new Error('수수료는 0-100 사이여야 합니다');
                }
            }
            return true;
        })
];
```

---

## 🔑 핵심 변경사항

### 1. `optional({ checkFalsy: true })` 사용

```javascript
// Before:
.optional({ nullable: true })  // null, undefined만 허용

// After:
.optional({ checkFalsy: true })  // null, undefined, "", 0, false 모두 허용
```

### 2. `custom()` 검증 사용

```javascript
.custom((value) => {
    // 값이 있을 때만 검증
    if (value) {
        // 검증 로직
    }
    return true;
})
```

**장점**:
- ✅ 유연한 검증 로직
- ✅ 빈 값과 실제 값 구분
- ✅ 명확한 에러 메시지

---

## 🧪 테스트

### 성공 케이스

#### 1. 모든 필드 입력
```json
{
  "name": "테스트 기업",
  "businessNumber": "123-45-67890",
  "email": "test@example.com",
  "commission": "10"
}
```
**결과**: ✅ 성공

#### 2. 필수 필드만 입력
```json
{
  "name": "테스트 기업",
  "businessNumber": "",
  "email": "",
  "commission": ""
}
```
**결과**: ✅ 성공 (빈 문자열 허용)

#### 3. 일부 선택 필드만 입력
```json
{
  "name": "테스트 기업",
  "businessNumber": "123-45-67890",
  "email": "",
  "commission": ""
}
```
**결과**: ✅ 성공

---

### 실패 케이스 (정상 동작)

#### 1. 기업명 누락
```json
{
  "name": "",
  "businessNumber": "123-45-67890"
}
```
**결과**: ❌ "기업명은 필수입니다"

#### 2. 잘못된 사업자번호 형식
```json
{
  "name": "테스트 기업",
  "businessNumber": "1234567890"  // 하이픈 없음
}
```
**결과**: ❌ "사업자번호 형식이 올바르지 않습니다 (예: 123-45-67890)"

#### 3. 잘못된 이메일 형식
```json
{
  "name": "테스트 기업",
  "email": "invalid-email"
}
```
**결과**: ❌ "올바른 이메일 형식이 아닙니다"

#### 4. 수수료 범위 초과
```json
{
  "name": "테스트 기업",
  "commission": "150"
}
```
**결과**: ❌ "수수료는 0-100 사이여야 합니다"

---

## 📝 배운 점

### `express-validator`의 `optional()` 옵션

| 옵션 | 허용 값 | 사용 시기 |
|------|---------|----------|
| `optional()` | `null`, `undefined` | 기본 사용 |
| `optional({ nullable: true })` | `null`, `undefined` | null 명시적 허용 |
| `optional({ checkFalsy: true })` | `null`, `undefined`, `""`, `0`, `false` | 빈 문자열도 허용 |

### 웹 폼과 API의 특성

```javascript
// HTML 폼에서 빈 입력 필드:
<input name="email" value="">  // → ""로 전송 (빈 문자열)

// JavaScript에서:
const data = {
    email: document.getElementById('email').value  // 빈 필드 → ""
};
```

**결론**: 웹 API에서는 `checkFalsy: true` 옵션이 더 적합!

---

## ⚡ 서버 재시작 완료

```
✅ 서버 실행 중: http://localhost:3001
✅ 수정사항 적용 완료
```

---

## ✅ 해결 완료!

이제 기업 추가가 정상적으로 작동합니다:

1. **필수 필드 (기업명)만 입력해도 OK** ✅
2. **선택 필드를 비워둬도 OK** ✅
3. **잘못된 형식은 여전히 차단** ✅

**브라우저를 새로고침하고 기업 추가를 다시 시도해보세요!** 🚀

---

**해결 일시**: 2026-02-02  
**소요 시간**: 5분  
**영향 범위**: `server.js` - `validateCompany` 미들웨어  
**상태**: ✅ 완료

