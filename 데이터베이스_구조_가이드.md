# 📊 1자리도약장려금 시스템 - 데이터베이스 구조 가이드

## 📋 목차
1. [테이블 개요](#테이블-개요)
2. [테이블 상세 구조](#테이블-상세-구조)
3. [데이터 흐름도](#데이터-흐름도)
4. [화면별 데이터 연결](#화면별-데이터-연결)

---

## 테이블 개요

시스템은 총 **4개의 핵심 테이블**로 구성되어 있습니다:

```
┌─────────────────┐
│    companies    │  ← 기업 정보
└────────┬────────┘
         │ 1:N
         ▼
┌─────────────────┐
│   employees     │  ← 근로자 정보 (장려금 관리)
└────────┬────────┘
         │ 1:N
         ▼
┌─────────────────┐
│     memos       │  ← 근로자별 메모
└─────────────────┘

┌─────────────────┐
│   company_to    │  ← 기업별 TO정보 (별도 관리)
└─────────────────┘

┌─────────────────┐
│   admin_users   │  ← 관리자 계정 (로그인용)
└─────────────────┘
```

---

## 테이블 상세 구조

### 1️⃣ `companies` 테이블 - 기업 정보

**역할**: 장려금을 신청하는 기업의 기본 정보 저장

**주요 컬럼**:
```sql
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,                    -- 기업명
    business_number TEXT,                  -- 사업자번호
    representative TEXT,                   -- 대표자명
    id_number TEXT,                        -- 주민등록번호
    phone TEXT,                            -- 전화번호
    email TEXT,                            -- 이메일
    password TEXT,                         -- 비밀번호 (해시됨)
    site_url TEXT,                         -- 사이트 URL
    commission INTEGER DEFAULT 0,          -- 수수료율 (%)
    active BOOLEAN DEFAULT true,           -- 활성 상태
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**데이터 입력 경로**:
```
[화면] → [API] → [DB 테이블]

📱 대시보드 "기업 추가" 버튼
   → 입력 폼 작성 (기업명, 대표자, 전화번호 등)
   → POST /api/companies
   → companies 테이블에 INSERT
```

**예시 데이터**:
| name | representative | commission | active |
|------|---------------|------------|--------|
| (주)경리업무를잘하는청년들 | 금종석 | 0 | true |
| 하우스스튜디오 | 박경섭 | 12 | true |
| 머바르니 네일 기흥본점 | 조현희 | 20 | true |

---

### 2️⃣ `employees` 테이블 - 근로자 정보 (핵심!)

**역할**: 근로자별 입사 정보 + 장려금 신청/지급 내역 관리

**주요 컬럼**:
```sql
CREATE TABLE employees (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID REFERENCES companies(id),  -- 소속 기업 (FK)
    name TEXT NOT NULL,                        -- 근로자명
    hire_date DATE,                            -- 입사일
    hire_year INTEGER,                         -- 입사년도
    business_type TEXT,                        -- 유형 (유형1/유형2)
    
    -- 사업신청 정보
    business_applied_date DATE,                -- 사업신청일
    business_applied_complete BOOLEAN,         -- 사업신청 완료 여부
    
    -- 고용신고 정보
    hiring_notify_date DATE,                   -- 고용신고일
    hiring_notify_complete BOOLEAN,            -- 고용신고 완료 여부
    
    -- 1차 지급 (입사 후 7개월)
    round1_due_date DATE,                      -- 신청마감일
    round1_applied_date DATE,                  -- 신청일
    round1_paid BOOLEAN,                       -- 지급 완료
    round1_paid_date DATE,                     -- 지급일
    round1_amount INTEGER,                     -- 지급액
    
    -- 2차 지급 (입사 후 10개월)
    round2_due_date DATE,
    round2_applied_date DATE,
    round2_paid BOOLEAN,
    round2_paid_date DATE,
    round2_amount INTEGER,
    
    -- 3차 지급 (입사 후 13개월)
    round3_due_date DATE,
    round3_applied_date DATE,
    round3_paid BOOLEAN,
    round3_paid_date DATE,
    round3_amount INTEGER,
    
    -- 4차 지급 (입사 후 2년)
    round4_due_date DATE,
    round4_applied_date DATE,
    round4_paid BOOLEAN,
    round4_paid_date DATE,
    round4_amount INTEGER,
    
    -- 퇴사 정보
    resigned BOOLEAN DEFAULT false,
    resigned_date DATE,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**데이터 입력 경로**:
```
[화면] → [API] → [DB 테이블]

📱 특정 기업 클릭 → "근로자 추가" 버튼
   → 입력 폼 작성 (이름, 입사일, 유형 등)
   → POST /api/employees
   → employees 테이블에 INSERT
   → 입사일 기준으로 round1~4 마감일 자동 계산

📱 근로자 행 더블클릭 → 상세 정보 수정
   → PUT /api/employees/:id
   → employees 테이블 UPDATE

📱 체크박스 클릭 (신청완료, 지급완료 등)
   → PUT /api/employees/:id
   → 해당 컬럼 true/false 업데이트
```

**계산 로직** (중요!):
- **입사일 입력** → 시스템이 자동으로 각 차수 마감일 계산
  - 1차: 입사일 + 7개월
  - 2차: 입사일 + 10개월
  - 3차: 입사일 + 13개월
  - 4차: 입사일 + 24개월

**예시 데이터**:
| name | company_id | hire_date | round1_due_date | round1_paid | resigned |
|------|------------|-----------|-----------------|-------------|----------|
| 정소진 | xxx-xxx | 2023-01-13 | 2023-08-13 | ✅ true | ✅ true |
| 이예림 | xxx-xxx | 2023-08-14 | 2024-03-14 | ✅ true | ❌ false |
| 김동건 | xxx-xxx | 2024-01-15 | 2024-08-15 | ✅ true | ❌ false |

---

### 3️⃣ `memos` 테이블 - 메모

**역할**: 근로자별로 관리자가 작성하는 메모 저장

**주요 컬럼**:
```sql
CREATE TABLE memos (
    id TEXT PRIMARY KEY,                       -- UUID
    employee_id TEXT REFERENCES employees(id), -- 근로자 FK
    content TEXT NOT NULL,                     -- 메모 내용
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**데이터 입력 경로**:
```
[화면] → [API] → [DB 테이블]

📱 근로자 더블클릭 → 상세 모달
   → 하단 "메모" 탭
   → 메모 작성 후 "저장"
   → POST /api/memos
   → memos 테이블에 INSERT

📱 메모 삭제 버튼 클릭
   → DELETE /api/memos/:id
   → memos 테이블에서 DELETE
```

**관계**:
- `employee_id`로 `employees` 테이블과 연결
- 한 명의 근로자가 여러 개의 메모를 가질 수 있음 (1:N)

**예시 데이터**:
| id | employee_id | content | created_at |
|----|-------------|---------|------------|
| memo-001 | emp-123 | 다음 주 서류 제출 필요 | 2025-01-15 |
| memo-002 | emp-123 | 지급 완료 확인함 | 2025-01-20 |

---

### 4️⃣ `company_to` 테이블 - TO정보

**역할**: 기업별 연도별 TO(정원) 정보 저장

**주요 컬럼**:
```sql
CREATE TABLE company_to (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID REFERENCES companies(id),  -- 기업 FK
    year INTEGER NOT NULL,                     -- 연도
    to_count INTEGER NOT NULL,                 -- TO 인원
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, year)                   -- 기업+연도 조합 유일
);
```

**데이터 입력 경로**:
```
[화면] → [API] → [DB 테이블]

📱 대시보드 "TO정보 관리" 버튼
   → 기업 선택, 연도/인원 입력
   → POST /api/to
   → company_to 테이블에 INSERT

📱 TO정보 삭제
   → DELETE /api/to/:companyId/:year
   → company_to 테이블에서 DELETE
```

**예시 데이터**:
| company_id | year | to_count |
|------------|------|----------|
| comp-001 | 2023 | 5 |
| comp-001 | 2024 | 8 |
| comp-002 | 2025 | 3 |

---

### 5️⃣ `admin_users` 테이블 - 관리자 계정

**역할**: 시스템 로그인용 관리자 계정 정보

**주요 컬럼**:
```sql
CREATE TABLE admin_users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username TEXT UNIQUE NOT NULL,             -- 아이디
    password TEXT NOT NULL,                    -- 비밀번호 (bcrypt 해시)
    name TEXT,                                 -- 관리자 이름
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**데이터 입력 경로**:
```
[화면] → [API] → [DB 테이블]

📱 로그인 페이지
   → 아이디/비밀번호 입력
   → POST /api/auth/login
   → admin_users 테이블 조회
   → 비밀번호 bcrypt 검증
   → JWT 토큰 발급

📱 비밀번호 변경
   → POST /api/auth/change-password
   → admin_users 테이블 UPDATE
```

**기본 계정**:
- 아이디: `admin`
- 초기 비밀번호: `1234` (반드시 변경 필요!)

---

## 데이터 흐름도

### 📊 기업 → 근로자 → 메모 관계

```
┌─────────────────────────────────────────────┐
│  1. 기업 등록                               │
│  POST /api/companies                        │
│  companies 테이블에 INSERT                  │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  2. 근로자 등록                             │
│  POST /api/employees                        │
│  - company_id로 기업과 연결                 │
│  - 입사일 기준 마감일 자동 계산             │
│  employees 테이블에 INSERT                  │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  3. 장려금 신청/지급 관리                   │
│  PUT /api/employees/:id                     │
│  - 체크박스 클릭 → 컬럼 업데이트            │
│  - round1_paid, round2_applied_date 등      │
│  employees 테이블 UPDATE                    │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  4. 메모 작성 (선택사항)                    │
│  POST /api/memos                            │
│  - employee_id로 근로자와 연결              │
│  memos 테이블에 INSERT                      │
└─────────────────────────────────────────────┘
```

### 🔄 TO정보 관리 (독립적)

```
┌─────────────────────────────────────────────┐
│  TO정보 등록                                │
│  POST /api/to                               │
│  - company_id + year 조합                   │
│  company_to 테이블에 INSERT                 │
└─────────────────────────────────────────────┘
```

---

## 화면별 데이터 연결

### 🏠 대시보드 화면 (`index.html`)

**API**: `GET /api/dashboard`

**조회하는 테이블**:
1. `companies` - 기업 목록
2. `employees` - 각 기업의 근로자 목록
3. `company_to` - 기업별 TO정보

**화면 구성**:
```
┌────────────────────────────────────────┐
│  [기업명]          TO: 5명  수수료: 12%│ ← companies 테이블
├────────────────────────────────────────┤
│  근로자명  입사일   1차  2차  3차  4차 │
│  ----------------------------------------│
│  김철수   2023-01   ✅  ✅  ✅  ⬜  │ ← employees 테이블
│  이영희   2024-05   ✅  ⬜  ⬜  ⬜  │   (company_id로 필터링)
│  박지민   2025-03   ⬜  ⬜  ⬜  ⬜  │
└────────────────────────────────────────┘
```

### ➕ 기업 추가 모달

**입력 항목** → **companies 테이블 컬럼**:
- 기업명 → `name`
- 사업자번호 → `business_number`
- 대표자명 → `representative`
- 주민등록번호 → `id_number`
- 전화번호 → `phone`
- 이메일 → `email`
- 비밀번호 → `password` (bcrypt 해시됨)
- 사이트 URL → `site_url`
- 수수료율 → `commission`

**API**: `POST /api/companies`

### ➕ 근로자 추가 모달

**입력 항목** → **employees 테이블 컬럼**:
- 이름 → `name`
- 입사일 → `hire_date` (자동으로 round1~4 마감일 계산)
- 입사년도 → `hire_year`
- 유형 → `business_type` (유형1/유형2)
- 사업신청일 → `business_applied_date`
- 고용신고일 → `hiring_notify_date`

**API**: `POST /api/employees`

**자동 계산**:
```javascript
입사일: 2023-01-15 입력
→ round1_due_date: 2023-08-15 (입사일 + 7개월)
→ round2_due_date: 2023-11-15 (입사일 + 10개월)
→ round3_due_date: 2024-02-15 (입사일 + 13개월)
→ round4_due_date: 2025-01-15 (입사일 + 24개월)
```

### 📝 근로자 상세 모달 (더블클릭)

**API**: `GET /api/employees` (필터링)

**표시 데이터**:
1. **기본 정보** (employees 테이블)
2. **메모 목록** (memos 테이블, `employee_id`로 조인)

**수정 가능 항목**:
- 모든 체크박스 (신청완료, 지급완료 등)
- 날짜 필드 (신청일, 지급일 등)
- 금액 필드 (지급액)
- 퇴사 정보

**API**: `PUT /api/employees/:id`

### 📋 TO정보 관리

**API**: 
- `POST /api/to` - TO 등록
- `GET /api/to/:companyId/status` - 기업의 TO정보 조회
- `DELETE /api/to/:companyId/:year` - TO 삭제

**입력 → DB**:
- 기업 선택 → `company_id`
- 연도 → `year`
- TO 인원 → `to_count`

---

## 💡 핵심 데이터 흐름 요약

### 1️⃣ 신규 근로자 등록 시 전체 흐름

```
사용자 입력:
  기업명: "(주)경리업무를잘하는청년들" 선택
  이름: "김철수"
  입사일: "2025-01-15"
  유형: "유형1"

↓ POST /api/employees

서버 처리:
  1. company_id 확인 (기업명으로 조회)
  2. 입사일 기준 마감일 계산
     - round1_due_date: 2025-08-15
     - round2_due_date: 2025-11-15
     - round3_due_date: 2026-02-15
     - round4_due_date: 2027-01-15
  3. employees 테이블에 INSERT

↓

DB 저장:
  employees 테이블에 새 행 추가
  - company_id: "xxx-xxx-xxx"
  - name: "김철수"
  - hire_date: "2025-01-15"
  - round1_due_date: "2025-08-15"
  - round1_paid: false (초기값)
  ...

↓

화면 갱신:
  해당 기업의 근로자 목록에 "김철수" 표시
```

### 2️⃣ 장려금 신청/지급 체크 시

```
사용자 액션:
  김철수의 1차 "신청완료" 체크박스 클릭

↓ PUT /api/employees/:id

서버 처리:
  employees 테이블 UPDATE
  SET round1_applied_date = '2025-08-13',
      updated_at = NOW()
  WHERE id = 'emp-xxx'

↓

DB 업데이트:
  해당 근로자의 round1_applied_date 컬럼에 날짜 저장

↓

화면 갱신:
  체크박스 체크 상태 유지, 날짜 표시
```

### 3️⃣ 메모 작성 시

```
사용자 액션:
  김철수 상세 모달 → 메모 탭 → "다음 주 서류 제출" 입력

↓ POST /api/memos

서버 처리:
  memos 테이블 INSERT
  - id: 자동 생성 UUID
  - employee_id: 'emp-xxx'
  - content: "다음 주 서류 제출"
  - created_at: NOW()

↓

DB 저장:
  memos 테이블에 새 행 추가

↓

화면 갱신:
  메모 목록에 새 메모 표시
```

---

## 🔍 자주 사용하는 쿼리 패턴

### 특정 기업의 근로자 전체 조회
```sql
SELECT e.*, c.name as company_name
FROM employees e
JOIN companies c ON c.id = e.company_id
WHERE c.id = '기업ID'
ORDER BY e.hire_date DESC;
```

### 1차 지급 대기 중인 근로자 조회
```sql
SELECT e.*, c.name as company_name
FROM employees e
JOIN companies c ON c.id = e.company_id
WHERE e.round1_paid = false
  AND e.round1_due_date < NOW()
  AND e.resigned = false
ORDER BY e.round1_due_date;
```

### 특정 근로자의 메모 전체 조회
```sql
SELECT *
FROM memos
WHERE employee_id = '근로자ID'
ORDER BY created_at DESC;
```

### 기업별 TO 정보 조회
```sql
SELECT ct.year, ct.to_count, c.name as company_name
FROM company_to ct
JOIN companies c ON c.id = ct.company_id
WHERE ct.company_id = '기업ID'
ORDER BY ct.year DESC;
```

---

## 📌 중요 참고사항

### 1. 외래키(Foreign Key) 관계
```
companies (1) ──── (N) employees
                      │
                      └── (N) memos

companies (1) ──── (N) company_to
```

### 2. 데이터 삭제 주의
- **기업 삭제**: 해당 기업의 모든 근로자와 메모도 함께 삭제됨 (`ON DELETE CASCADE`)
- **근로자 삭제**: 해당 근로자의 모든 메모도 함께 삭제됨
- **TO정보 삭제**: 독립적으로 삭제 가능

### 3. 날짜 자동 계산
- 근로자 입사일 입력 시, 1~4차 마감일은 **서버에서 자동 계산**
- 프론트엔드(`app.js`)의 `calculateDueDate()` 함수 사용
- 계산 로직:
  ```javascript
  1차: 입사일 + 7개월
  2차: 입사일 + 10개월
  3차: 입사일 + 13개월
  4차: 입사일 + 24개월
  ```

### 4. 수수료 자동 계산
- 대시보드 하단 수수료 현황에서 자동 집계
- 계산식: `지급액 × (수수료율 / 100)`
- 예: 지급액 1,200,000원, 수수료율 12% → 144,000원

---

## 🎯 실전 시나리오

### 시나리오 1: 신규 기업 + 근로자 등록

```
1. [대시보드] "기업 추가" 클릭
   → 기업명: "테스트기업", 대표자: "홍길동", 수수료: 15%
   → POST /api/companies
   → companies 테이블에 INSERT

2. 새로 추가된 "테스트기업" 클릭
   → "근로자 추가" 클릭
   → 이름: "김테스트", 입사일: "2025-02-01"
   → POST /api/employees
   → employees 테이블에 INSERT
   → round1_due_date 자동 계산: 2025-09-01

3. 근로자 행 더블클릭
   → 상세 정보 확인
   → 메모 작성: "신규 근로자 등록 완료"
   → POST /api/memos
   → memos 테이블에 INSERT
```

### 시나리오 2: 장려금 신청/지급 처리

```
1. 대시보드에서 "김테스트" 근로자 찾기
   → 1차 마감일 도래 확인

2. 1차 "신청완료" 체크박스 클릭
   → PUT /api/employees/:id
   → round1_applied_date에 오늘 날짜 저장

3. 며칠 후 지급 완료 시
   → 1차 "지급완료" 체크박스 클릭
   → PUT /api/employees/:id
   → round1_paid = true, round1_paid_date에 날짜 저장

4. 수수료 현황에 자동 반영
   → 지급액 × 15% 계산되어 표시
```

### 시나리오 3: 퇴사 처리

```
1. 근로자 더블클릭 → 상세 모달
   → "퇴사" 체크박스 클릭
   → 퇴사일 입력: "2025-12-31"
   → PUT /api/employees/:id
   → resigned = true, resigned_date 저장

2. 대시보드에서 해당 근로자 행이 회색으로 표시됨
   → 시각적으로 퇴사자 구분
```

---

## 📚 추가 참고 자료

- **SQL 파일 위치**:
  - `create_memos_table.sql` - memos 테이블 생성
  - `insert_companies.sql` - 기업 샘플 데이터
  - `insert_employees.sql` - 근로자 샘플 데이터

- **API 엔드포인트**: `server.js` 파일 참고
- **프론트엔드 로직**: `public/js/app.js` 파일 참고

---

**작성일**: 2026-02-02  
**버전**: 1.0

